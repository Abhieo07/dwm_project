<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... (your meta tags and other head elements) ... -->
    <title>Main</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Analyze your data here!!</h1>
    <div>
        <h2>{{ clean }}</h2>
        <form method="post" enctype="multipart/form-data" id="file-upload">
            {% csrf_token %}
            <label for="file_">Upload your data here</label>
            <input id="file_" type="file" name='uploaded-file' accept=".csv, .json, .xlsx"/>
            <!-- <input type="submit" value="Upload"> -->
        </form>
        <div>
            <select name="" id="chart-type">
                <option value="">Chart type</option>
            </select>
        </div>
        <div class="drop-menu">
            <div id="x-axis">
                <select id="x-columns" name="x-columns" class="options">
                    <option value="" disabled selected hidden>Select an option</option>
                </select>
            </div>
            <div id="y-axis">
                <select id="y-columns" name="y-columns" class="options">
                    <option value="">Select an option</option>
                </select>
            </div>
        </div>
        <!-- Add an empty div to hold the chart -->
        <div id="chart-container">
            <canvas id="chart" width="200px" height="200px"></canvas>
        </div>
    </div>

    <!-- <script>
        $(document).ready(function() {
            function handleFormSubmission(event) {
                event.preventDefault(); // Prevent the default form submission
    
                // Create a FormData object and append the file data
                var formData = new FormData();
                formData.append('uploaded-file', $('#file_')[0].files[0]);
    
                // Send an AJAX request to your Django view to get cleaned data
                $.ajax({
                    url: window.location.href,
                    type: 'POST',
                    data: formData,
                    processData: false, // Prevent jQuery from converting the data to a string
                    contentType: false, // Ensure the content type is set to multipart/form-data
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        if (response.data) {
                            console.log(response.data); // Log the response.data
                        }
                    },
                    error: function(err) {
                        console.log('AJAX request failed:', err);
                    }
                });
            }
    
            // Attach the form submission event to the form element
            $('#file-upload').submit(handleFormSubmission);
        });
    </script> -->
    
    <script>
        var previousChart = null;
        let chartType = 'scatter';
        let chartData = getRandomData();
        var chartOptions = ['scatter', 'bar'];




        
        const typeChange = document.querySelector('#chart-type');
        typeChange.addEventListener('change', ()=>{
            console.log(typeChange.options[typeChange.selectedIndex].value);

            chartType = typeChange.options[typeChange.selectedIndex].value;
            console.log(chartType, chartData);
            const ctx = document.getElementById('chart').getContext('2d');
            createChart(chartType,chartData,ctx);
        })

        function populateChartTypes(options) {
            var select = $('#chart-type');
            select.empty();  // Clear existing options

            select.append($('<option>').val("select-chart").text("select-chart"));

            $.each(options, function(index, option) {
                select.append($('<option>').val(option).text(option));
            });
        }

        function getRandomData() {
            // Generate random data for demonstration
            var x = [];
            var y = [];
            for (let index = 0; index < 30; index++) {
                x.push(Math.floor(Math.random() * 100)); 
            }
            for (let index = 0; index < x.length; index++) {
                y.push(Math.floor(Math.random() * 101))  
            }

            var regression = linearRegression(x, y);
            return {
                datasets: [{
                    label: 'Linear Regression',
                    data: x.map((x, i) => ({ x, y: regression.equation[0] * x + regression.equation[1] })),
                    showLine: true,
                    borderColor: 'blue',
                }, {
                    label: 'Data Points',
                    data: x.map((x, i) => ({ x, y: y[i] })),
                    pointBackgroundColor: 'red',
                }],
            };
        }

        function createChart(type, data, ctx) {
            if (previousChart) {
                previousChart.destroy();
                previousChart = null;
            }
            chart = new Chart(ctx, {
                type: type,
                data: data,
                options: {
                responsive: true,
                scales: {
                    x: {
                    ticks: {
                        font: {
                        size: 16 
                        }
                    }
                    },
                    y: {
                    ticks: {
                        font: {
                        size: 16
                        }
                    }
                    }
                }
                },
            });

            previousChart = chart;
        }

        function updateChart(data){

            // select x-column
            var x= document.querySelector("#x-columns");
            x = x.options[x.selectedIndex].value;
            console.log(x)
            console.log(data[x])
            // select y-column
            var y= document.querySelector("#y-columns");
            y = y.options[y.selectedIndex].value;
            console.log(y)
            console.log(data[y])

            var xValues = Object.values(data[x]);
            var yValues = Object.values(data[y]);

            // get chartData
            if(chartType === 'scatter'){
                console.log("chart-type scatter");
                chartData = linearRegData(xValues, yValues);
            }
            else if(chartType === 'bar'){
                console.log("chart-type bar");
                chartData = categoricalData(data);
            }
            // create the chart
            const ctx = document.getElementById('chart').getContext('2d');
            createChart(chartType, chartData, ctx);
        }
        
        const linearRegData = (xValues, yValues) => {
            var regression = linearRegression(xValues, yValues);
            return {
                datasets: [{
                    label: 'Linear Regression',
                    data: xValues.map((x, i) => ({ x, y: regression.equation[0] * x + regression.equation[1] })),
                    showLine: true,
                    borderColor: 'blue',
                }, {
                    label: 'Data Points',
                    data: xValues.map((x, i) => ({ x, y: yValues[i] })),
                    pointBackgroundColor: 'red',
                }],
            }
        }

        const categoricalData = (data) => {
            const categories = Object.keys(data);
            const categoriVal = categories.map(category => Object.values(data[category]));
            var labels = Object.keys(data[categories[0]]);
            var datasets = categories.map((category, index) => {
                return {
                    label: category,
                    data: categoriVal[index],
                    backgroundColor: 'rgba(75, 192, 192, 0.2)', // Customize the colors as needed
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                };
            });

            return {
                labels: categories,
                datasets: datasets,
            }
        }








        $(document).ready(function() {

            const ctx = document.getElementById('chart').getContext('2d');
            createChart(chartType, chartData, ctx);

            // populate chart-type options
            populateChartTypes(chartOptions);

            function handleFileChange(event) {
                // Create a FormData object and append the file data
                var formData = new FormData();
                formData.append('uploaded-file', event.target.files[0]);
    
                // Send an AJAX request to your Django view to get cleaned data
                $.ajax({
                    url: window.location.href,
                    type: 'POST',
                    data: formData,
                    processData: false, // Prevent jQuery from converting the data to a string
                    contentType: false, // Ensure the content type is set to multipart/form-data
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        var data = JSON.parse(response.data);

                        if (data) {
                            console.log(data); // Log the response.data
                            var columns = Object.keys(data);
                            populateOptions(columns);

                            const optionChange = document.querySelectorAll(".options");
                            optionChange.forEach(option => {
                                option.addEventListener('change', ()=>{

                                    updateChart(data);
                                });
                            });

                        }
                    },
                    error: function(err) {
                        console.log('AJAX request failed:', err);
                    }
                });
            }
    
            // Attach the file change event to the file input element
            $('#file_').on('change', handleFileChange);
        });


        function populateOptions(options) {
            var select = $('.options');
            select.empty();  // Clear existing options

            select.append($('<option>').val("select-an-option").text("select-an-option"));

            $.each(options, function(index, option) {
                select.append($('<option>').val(option).text(option));
            });
        }

        // Function to calculate linear regression
        function linearRegression(x, y) {
            var n = x.length;
            var sumX = x.reduce((a, b) => a + b, 0);
            var sumY = y.reduce((a, b) => a + b, 0);
            var sumXY = x.map((xi, i) => xi * y[i]).reduce((a, b) => a + b, 0);
            var sumX2 = x.map(xi => xi ** 2).reduce((a, b) => a + b, 0);
            var slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX ** 2);
            var intercept = (sumY - slope * sumX) / n;
            return { equation: [slope, intercept] };
        }

    </script>
    
    
</body>
</html>
